{
    auto_https off
    admin off
}

:80 {
    root * /app
    
    # PHP API endpoints - processar primeiro
    @php {
        path *.php /api/* /user/* /ranking/* /pix/* /monetag/* /admin/* /admin-panel/* /invite/* /history/* /settings/* /withdraw/* /notifications/* /database/* /middleware/* /migrations/* /routes/*
    }
    handle @php {
        php_server
    }
    
    # Servir arquivos estáticos do site React na pasta public
    handle /assets/* {
        root * /app/public
        file_server
    }
    
    handle /__manus__/* {
        root * /app/public
        file_server
    }
    
    # Rota para o site React (SPA) - rotas /auth, /tasks, /
    # Qualquer rota que não seja PHP vai para o SPA
    handle {
        root * /app/public
        try_files {path} /index.html
        file_server
    }
    
    # Configuração CORS com todos os headers de segurança
    header {
        # CORS
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-Device-ID, X-Timestamp, X-Signature, X-Proof-Of-Work, X-Challenge, X-Response, X-Request-ID, X-Client-Nonce, X-App-Version, X-Platform, X-Platform-Version, X-Device-Model, X-Session-ID, X-Device-Fingerprint, X-Body-Hash, X-Headers-Hash, X-Full-Request-Hash, X-Encryption-Version, X-Key-Window, X-Security-Level, X-Cipher-Algorithm, X-HMAC-Algorithm, X-API-Version, X-Client-Type, X-User-Agent-Hash, X-Origin-Validation, X-Access-Token-Hash, X-Request-Window, X-Nonce-Signature, X-Rate-Limit-Key, X-Request-Priority, X-Challenge-Response, X-Request-Sequence, X-Request-Timestamp"
        Access-Control-Allow-Credentials "true"
        Access-Control-Max-Age "86400"
        
        # Security Headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Responder a requisições OPTIONS (preflight)
    @options {
        method OPTIONS
    }
    respond @options 200
    
    # Bloquear acesso a arquivos sensíveis
    @blocked {
        path *.env *.sql *.log *.bak *.config .git/*
    }
    respond @blocked 403
}
